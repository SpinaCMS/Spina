// Generated by CoffeeScript 2.5.0
(function() {
  var ready, show_page_parts;

  ready = function() {
    var page_parts;
    if ($.isFunction($.fn.nestable)) {
      $('.dd').nestable({
        maxDepth: "<%= Spina.config.max_page_depth %>"
      });
    }
    if ($('.page-template').length > 0) {
      page_parts = $('.page-template').data('page-parts');
      show_page_parts(page_parts);
    }
    $('.sortable-grid').sortable().bind('sortupdate', function(e) {
      var position_array;
      position_array = [];
      $(e.target).find('li.image').each(function(index) {
        return position_array.push($(this).data('image-id'));
      });
      return $(e.target).parents('.horizontal-form-content').find('.image-positions').val(position_array.join(","));
    });
    return $('.structure-form-menu ul').sortable().bind('sortupdate', function(e) {
      return $(e.target).find('li').each(function(index) {
        var id;
        id = $(this).data('structure-item-id');
        return $(`.structure_form_pane_${id}_position`).val(index);
      });
    });
  };

  $(document).on('turbolinks:load', ready);

  // Change templates makes page parts appear and disappear
  $(document).on('change', '.page-template select', function() {
    var page_parts;
    page_parts = $(this).find('option:selected').data('page-parts').split(" ");
    return show_page_parts(page_parts);
  });

  show_page_parts = function(page_parts) {
    var i, len, page_part, results;
    $('.horizontal-form-group.page-part').hide();
    results = [];
    for (i = 0, len = page_parts.length; i < len; i++) {
      page_part = page_parts[i];
      results.push($('.horizontal-form-group.page-part[data-name=' + page_part + ']').show());
    }
    return results;
  };

  // Dynamically add and remove structures
  $(document).on('click', 'form .add_structure_item_fields', function(event) {
    var $fields, $link, $structureForm, regexp, time;
    $structureForm = $(this).parents('.structure-form');
    time = new Date().getTime();
    regexp = new RegExp(`${$(this).data('id')}|new_association`, 'g');
    $fields = $($(this).data('fields').replace(regexp, time));
    $structureForm.find('.structure-form-content').append($fields);
    $link = $(`<li><a href='#structure_form_pane_${time}'><i class='icon icon-bars'></i> </a></li>`);
    $structureForm.find('.structure-form-menu ul').append($link);
    $fields.attr('id', `structure_form_pane_${time}`);
    $link.find('a').click();
    // Fire event
    $structureForm.trigger('spina:structure_added');
    return event.preventDefault();
  });

  $(document).on('click', 'form .remove_structure_item_fields', function(event) {
    var $link, $pane, $previousLink;
    $(this).prev('input[type=hidden]').val('1');
    $pane = $(this).closest('.structure-form-pane');
    $link = $(`a[href='#${$pane.attr('id')}']`).parents('li');
    $previousLink = $link.siblings('li:visible');
    $previousLink.find('a').trigger('click');
    $link.hide();
    $pane.hide();
    return event.preventDefault();
  });

  $(document).on('change', '.structure-form-pane .structure-form-part:first-child input', function(event) {
    var $link, $pane, value;
    value = $(this).val();
    $pane = $(this).parents('.structure-form-pane');
    $link = $(`a[href='#${$pane.attr('id')}']`);
    return $link.html(`<i class='icon icon-bars'></i> ${value}`);
  });

  // Sort pages
  $(document).on('click', '.sort-switch', function(event) {
    $($(this).attr('href') + ' .dd-item-inner').toggleClass('dd-handle');
    if ($(this).hasClass('button-success')) {
      $(this).removeClass('button-success');
      $(this).text($(this).data('change-order'));
      $(this).prepend('<i class="icon icon-random"></i>');
    } else {
      $(this).addClass('button-success');
      $(this).text($(this).data('done-changing-order'));
      $(this).prepend('<i class="icon icon-check"></i>');
    }
    return false;
  });

}).call(this);
